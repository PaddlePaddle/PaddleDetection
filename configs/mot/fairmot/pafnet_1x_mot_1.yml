_BASE_: [
  #'../../datasets/mot.yml',
  '../../runtime.yml',
  '_base_/optimizer_30e.yml',
  '_base_/fairmot_dla34.yml',
  '_base_/fairmot_reader_1088x608.yml',
]

weights: output/pafnet_1x_mot/16.pdparams
pretrain_weights: https://paddledet.bj.bcebos.com/models/pafnet_10x_coco.pdparams
epoch: 36
metric: MOTDet
#metric: MOT
num_classes: 1
#log_iter: 1

FairMOT:
  detector: TTFNet
  reid: FairMOTEmbeddingHead
  loss: FairMOTLoss
  tracker: JDETracker
  for_mot: false
  

TTFNet:
  backbone: ResNet
  neck: TTFFPN
  ttf_head: TTFHead
  post_process: BBoxPostProcess
  #for_mot: true

ResNet:
  depth: 50
  variant: d
  return_idx: [0, 1, 2, 3]
  freeze_at: -1
  norm_decay: 0.
  variant: d
  dcn_v2_stages: [1, 2, 3]

TTFFPN:
  planes: [256, 128, 64]
  shortcut_num: [3, 2, 1]

TTFHead:
  dcn_head: true
  hm_loss:
    name: CTFocalLoss
    loss_weight: 1.
  wh_loss:
    name: GIoULoss
    loss_weight: 5.
    reduction: sum


BBoxPostProcess:
  decode:
    name: TTFBox
    max_per_img: 100
    score_thresh: 0.01
    down_ratio: 4
    #for_mot: true

JDETracker:
  conf_thres: 0.4
  tracked_thresh: 0.4
  metric_type: cosine

FairMOTLoss:
  det_weight: -1.05
  reid_weight: -1.85


LearningRate:
  base_lr: 0.0075
  schedulers:
  - !PiecewiseDecay
    gamma: 0.1
    milestones: [24, 33]
  - !LinearWarmup
    start_factor: 0.1
    steps: 500


OptimizerBuilder:
  optimizer:
    momentum: 0.9
    type: Momentum
  regularizer:
    factor: 0.0004
    type: L2

TrainReader:
  sample_transforms:
  - Decode: {}
  #- RandomFlip: {prob: 0.5}
  #- Resize: {interp: 1, target_size: [512, 512], keep_ratio: False}
  - LetterBoxResize: {target_size: [608, 1088]}
  - RandomFlip: {}
  - NormalizeImage: {mean: [123.675, 116.28, 103.53], std: [58.395, 57.12, 57.375], is_scale: false}
  - Permute: {}
  batch_transforms:
  - Gt2TTMOTTarget: {}
  batch_size: 6
  shuffle: true
  drop_last: true
  use_shared_memory: true


EvalReader:
  sample_transforms:
    - Decode: {}
    - LetterBoxResize: {target_size: [608, 1088]}
    - NormalizeImage: {mean: [123.675, 116.28, 103.53], std: [58.395, 57.12, 57.375], is_scale: false}
    - Permute: {}
  batch_size: 1
  drop_last: false


# for MOT training
TrainDataset:
  !MOTDataSet
    dataset_dir: /paddle/dataset/mix
    #image_lists: ['mot17.train', 'caltech.all', 'cuhksysu.train', 'prw.train', 'citypersons.train', 'eth.train']
    image_lists: ['mot17.half', 'caltech.all', 'cuhksysu.train', 'prw.train', 'citypersons.train', 'eth.train']
    #image_lists: ['mot17.train']
    data_fields: ['image', 'gt_bbox', 'gt_class', 'gt_ide']

EvalDataset:
  !MOTDataSet
    dataset_dir: /paddle/dataset/mix #dataset/mot
    #image_lists: ['citypersons.val', 'caltech.val'] # for detection evaluation
    image_lists: ['mot17.half.val']
    # image_lists: ['caltech.10k.val', 'cuhksysu.val', 'prw.val'] # for reid evaluation
    data_fields: ['image', 'gt_bbox', 'gt_class', 'gt_ide']

EvalMOTDataset:
  !MOTImageFolder
    dataset_dir: /paddle/dataset/mix
    data_root: MOT17/images/half
    keep_ori_im: False # set True if save visualization images or video, or used in DeepSORT
